<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Museo Interactivo - MVP</title>
        <link rel="stylesheet" href="styles.css" />
    </head>
    <body>
        <!-- Protobject -->
        <script src="https://app.protobject.com/framework/p.js"></script>
        <script src="config.js"></script>

        <header class="site-header">
            <h1>Museo Interactivo</h1>
            <p class="subtitle">Escanea un marcador y elige la obra</p>
        </header>

        <main id="main">
            <section class="actions" id="actions" aria-live="polite"></section>
        </main>

        <!-- Viewer: modal full-screen en mobile -->
        <section class="viewer" id="viewer" aria-hidden="true">
            <button
                class="btn btn-fab"
                id="btnVolver"
                aria-label="Volver a la cámara"
            >
                ↩
            </button>
            <div class="viewer-grid">
                <figure class="art-figure">
                    <img id="artImg" alt="Obra seleccionada" />
                    <figcaption id="artCaption" class="sr-only">
                        Imagen de la obra seleccionada
                    </figcaption>
                </figure>
                <div class="meta">
                    <h2 id="artTitle"></h2>
                    <p id="artDesc"></p>
                    <audio id="artAudio" preload="auto" controls></audio>
                    <div class="pill-info" id="artInfo"></div>
                </div>
            </div>
        </section>

        <footer class="site-footer">
            <small>Prototipo educativo • Demo</small>
        </footer>

        <script>
            // ===== Contenidos =====
            const ARTWORKS = {
                1: {
                    title: "Obra 1 — Ejemplo",
                    img: "Imagenes/obra1.jpeg",
                    audio: "Audios/obra1.mp3",
                    description:
                        "Descripción breve de la obra 1. Autor, año, técnica, contexto.",
                    info: ["óleo sobre lienzo", "1889", "Van Gogh"],
                },
                2: {
                    title: "Obra 2 — Ejemplo",
                    img: "Imagenes/obra2.jpeg",
                    audio: "Audios/obra2.mp3",
                    description: "Descripción breve de la obra 2.",
                    info: ["temple", "1503", "Leonardo"],
                },
            };

            // ===== UI refs =====
            const actionsEl = document.getElementById("actions");
            const viewerEl = document.getElementById("viewer");
            const artImg = document.getElementById("artImg");
            const artTitle = document.getElementById("artTitle");
            const artDesc = document.getElementById("artDesc");
            const artAudio = document.getElementById("artAudio");
            const artInfo = document.getElementById("artInfo");
            const btnVolver = document.getElementById("btnVolver");
            const mainEl = document.getElementById("main");

            const shown = new Set();
            let previewEl = null;

            // ==== 1) Detectar el elemento de preview (video/canvas) ====
            const obs = new MutationObserver((mutations) => {
                for (const m of mutations) {
                    for (const node of m.addedNodes) {
                        if (!(node instanceof HTMLElement)) continue;
                        const candidate = node.matches?.("video,canvas")
                            ? node
                            : node.querySelector?.("video,canvas");
                        if (candidate && !previewEl) {
                            previewEl = candidate;
                            previewEl.setAttribute(
                                "data-protobject-preview",
                                "1",
                            );
                        }
                    }
                }
            });
            obs.observe(document.body, { childList: true, subtree: true });

            // ==== 2) Control robusto del preview ====
            function startPreviewSafely() {
                // Mueve el preview a una esquina pequeña para no tapar contenido
                const isMobile =
                    window.matchMedia("(max-width: 600px)").matches;
                const previewSize = isMobile
                    ? { w: 240, h: 160, top: 12, left: 12 }
                    : { w: 360, h: 240, top: 16, left: 16 };

                try {
                    Protobject.Aruco.start(200, 0);
                } catch {}
                try {
                    Protobject.Aruco.showPreview({
                        top: previewSize.top,
                        left: previewSize.left,
                        width: previewSize.w,
                        height: previewSize.h,
                    });
                } catch {}

                // Asegurar que se vea
                if (previewEl) {
                    previewEl.classList.remove("hidden");
                    previewEl.style.cssText = ""; // limpiar cualquier ocultamiento previo
                }

                // En móvil, deja margen superior para evitar superposición con el preview
                if (isMobile) {
                    mainEl.style.marginTop = previewSize.h + 20 + "px";
                } else {
                    mainEl.style.marginTop = "";
                }

                document.body.classList.remove("viewer-open");
            }

            function stopPreviewSafely() {
                // a) API del framework
                try {
                    if (Protobject.Aruco.stop) Protobject.Aruco.stop();
                } catch {}

                // b) Detener todas las pistas de cámara (por si la API no la apaga)
                document.querySelectorAll("video").forEach((v) => {
                    if (v.srcObject && v.srcObject.getTracks) {
                        v.srcObject.getTracks().forEach((t) => t.stop());
                    }
                });

                // c) Ocultar el elemento del preview por fuerza
                if (!previewEl) {
                    previewEl =
                        document.querySelector(
                            '[data-protobject-preview="1"]',
                        ) ||
                        document.querySelector(
                            'canvas[id*="Protobject"], video',
                        ) ||
                        null;
                }
                if (previewEl) {
                    previewEl.classList.add("hidden");
                    previewEl.style.visibility = "hidden";
                    previewEl.style.pointerEvents = "none";
                    previewEl.style.width = "0";
                    previewEl.style.height = "0";
                    previewEl.style.display = "none";
                }

                // Clase de estado para ocultarlo también por CSS
                document.body.classList.add("viewer-open");
                // Quitar margen de main cuando preview está oculto
                mainEl.style.marginTop = "";
            }

            // ==== 3) Botones por ID detectado ====
            function ensureButtonFor(id) {
                if (!ARTWORKS[id] || shown.has(id)) return;
                const btn = document.createElement("button");
                btn.className = "btn btn-primary btn-chip";
                btn.textContent = `Obra #${id}`;
                btn.setAttribute("aria-label", `Abrir obra ${id}`);
                btn.addEventListener("click", () => openArtwork(id));
                actionsEl.appendChild(btn);
                shown.add(id);
            }

            // ==== 4) Abrir obra (modal) ====
            async function openArtwork(id) {
                const art = ARTWORKS[id];
                if (!art) return;

                artImg.src = art.img;
                artImg.alt = art.title;
                artTitle.textContent = art.title;
                artDesc.textContent = art.description;
                artAudio.src = art.audio;
                artInfo.innerHTML = (art.info || [])
                    .map((x) => `<span class="pill">${x}</span>`)
                    .join("");

                viewerEl.classList.add("visible");
                viewerEl.setAttribute("aria-hidden", "false");

                stopPreviewSafely();

                try {
                    await artAudio.play();
                } catch {}
            }

            // ==== 5) Volver ====
            btnVolver.addEventListener("click", () => {
                artAudio.pause();
                viewerEl.classList.remove("visible");
                viewerEl.setAttribute("aria-hidden", "true");
                startPreviewSafely();
                actionsEl.querySelector(".btn")?.focus();
            });

            // ==== 6) Iniciar ====
            startPreviewSafely();
            Protobject.Aruco.onData((data) => {
                Object.keys(data).forEach((id) => ensureButtonFor(id));
            });

            document.addEventListener("DOMContentLoaded", () => {
                const plus = document.getElementById("ProtobjectPlusButton");
                if (plus) plus.setAttribute("aria-label", "Conectar cámara");
            });

            // Recalcular layout al rotar o cambiar tamaño (mobile)
            window.addEventListener("resize", () => {
                if (!document.body.classList.contains("viewer-open")) {
                    startPreviewSafely();
                }
            });
        </script>
    </body>
</html>
