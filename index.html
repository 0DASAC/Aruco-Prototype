<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Museo Interactivo - NFC</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <header class="site-header">
        <h1>Museo Interactivo</h1>
        <p class="subtitle">Acerca una etiqueta NFC para abrir la obra</p>
    </header>

    <main id="main">
        <section class="actions" id="statusArea" aria-live="polite">
            <span class="pill">NFC: <strong id="nfcStatus">inactivo</strong></span>
            <span class="pill" id="lastRead" hidden>último: <span id="lastKey"></span></span>
            <span class="pill" id="speedPill">
                Velocidad prom.: <strong id="avgSpeed">0.0</strong> m/s
            </span>
        </section>
    </main>

    <!-- Viewer: modal full-screen (responsive) -->
    <section class="viewer" id="viewer" aria-hidden="true">
        <button class="btn btn-fab" id="btnVolver" aria-label="Volver">
            ↩
        </button>
        <div class="viewer-grid">
            <figure class="art-figure">
                <img id="artImg" alt="Obra seleccionada" />
                <figcaption id="artCaption" class="sr-only">
                    Imagen de la obra seleccionada
                </figcaption>
            </figure>
            <div class="meta">
                <h2 id="artTitle"></h2>
                <p id="artDesc"></p>
                <audio id="artAudio" preload="auto" controls></audio>
                <div class="pill-info" id="artInfo"></div>
            </div>
        </div>
    </section>

    <footer class="site-footer">
        <small>Prototipo NFC • Solo Chrome Android + HTTPS</small>
    </footer>

    <script src="https://app.protobject.com/framework/p.js"></script>
    <script src="config.js"></script>
    <script src="artworks.js"></script>


    <script>
        const SPEED_THRESHOLDS = {
            short: 5.0,
            medium: 1.0,
        };

        const NFC_MAP = {
            "uid:a2:94:eb:89": 1,
            "uid:92:57:95:81": 2,
            "uid:2f:d4:b2:8d": 3,
            "uid:3f:d7:4d:68": 4,
            "url:https://mi/obra-1": 1,
        };

        const viewerEl = document.getElementById("viewer");
        const artImg = document.getElementById("artImg");
        const artTitle = document.getElementById("artTitle");
        const artDesc = document.getElementById("artDesc");
        const artAudio = document.getElementById("artAudio");
        const artInfo = document.getElementById("artInfo");
        const btnVolver = document.getElementById("btnVolver");

        const nfcStatus = document.getElementById("nfcStatus");
        const lastRead = document.getElementById("lastRead");
        const lastKeyEl = document.getElementById("lastKey");

        async function openArtworkById(obraId) {
            const art = ARTWORKS[obraId];
            if (!art) return;

            // parar audio anterior
            artAudio.pause();
            artAudio.currentTime = 0;

            const level = getDescriptionLevelFromSpeed(currentAvgSpeed);
            artDesc.textContent = art.descriptions[level];

            artImg.src = art.img;
            artImg.alt = art.title;
            artTitle.textContent = art.title;
            artAudio.src = art.audio;
            artInfo.innerHTML = (art.info || [])
                .map((x) => `<span class="pill">${x}</span>`)
                .join("");

            viewerEl.classList.add("visible");
            viewerEl.setAttribute("aria-hidden", "false");
            btnVolver.focus(); // accesibilidad

            try {
                await artAudio.play();
            } catch {
                // el usuario puede necesitar tocar el botón de play
            }
        }

        function closeViewer() {
            artAudio.pause();
            viewerEl.classList.remove("visible");
            viewerEl.setAttribute("aria-hidden", "true");
        }

        function getDescriptionLevelFromSpeed(v) {
            if (v > SPEED_THRESHOLDS.short) return "short";
            if (v > SPEED_THRESHOLDS.medium) return "medium";
            return "long";
        }

        function closeViewer() {
            artAudio.pause();
            viewerEl.classList.remove("visible");
            viewerEl.setAttribute("aria-hidden", "true");
        }

        btnVolver.addEventListener("click", closeViewer);

        // ===== 5) Web NFC: escaneo continuo =====
        let ndef;
        let lastKey = null;
        let lastAt = 0;
        const DUP_MS = 1500; // ignora lecturas idénticas durante este tiempo

        function setStatus(txt) {
            nfcStatus.textContent = txt;
        }

        function keyFromEvent(ev) {
            // 1) UID si está disponible
            if (ev.serialNumber) return `uid:${ev.serialNumber}`;

            // 2) Primer registro NDEF (text/url) si existe
            const msg = ev.message;
            if (msg && msg.records && msg.records.length) {
                const r = msg.records[0];
                try {
                    if (r.recordType === "text") {
                        const dec = new TextDecoder(
                            r.encoding || "utf-8",
                        ).decode(r.data);
                        return `text:${dec.trim()}`;
                    } else if (r.recordType === "url") {
                        const url = new TextDecoder().decode(r.data).trim();
                        return `url:${url}`;
                    }
                } catch { }
            }

            return null;
        }

        let isScanning = false;

        async function startScan() {
            if (!("NDEFReader" in window)) {
                setStatus("no soportado");
                alert("Este navegador no soporta Web NFC. Usa Chrome en Android y sirve por HTTPS.");
                return;
            }

            if (isScanning) return;

            try {
                ndef = new NDEFReader();
                await ndef.scan();
                isScanning = true;
                setStatus("escaneando");

                ndef.onreading = handleNfcReading;
                ndef.onreadingerror = () => setStatus("error lectura");
            } catch (err) {
                isScanning = false;
                setStatus("error");
                console.warn("Error NFC:", err);
                // reintento suave opcional
                // setTimeout(() => startScan().catch(() => {}), 2000);
            }
        }

        function handleNfcReading(event) {
            const key = keyFromEvent(event);
            if (!key) return;

            const now = Date.now();
            if (key === lastKey && now - lastAt < DUP_MS) return;

            lastKey = key;
            lastAt = now;

            lastRead.hidden = false;
            lastKeyEl.textContent = key;

            const obraId = NFC_MAP[key];
            if (obraId) openArtworkById(obraId);
        }


        // Arranca el escaneo al cargar (si el navegador lo permite).
        // Para máxima compatibilidad, puedes gatearlo detrás de un clic inicial si hace falta:
        document.addEventListener("DOMContentLoaded", () => {
            startScan();
            startAcceleration();
        });

        // Reintento al volver al tab (Android a veces pausa NFC)
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") {
                startScan();
            }
        });

        // ===== 7) Velocidad promedio usando el acelerómetro =====

        // Referencia al span de velocidad
        const avgSpeedEl = document.getElementById("avgSpeed");

        // Estado para integrar aceleración -> velocidad
        let vx = 0,
            vy = 0,
            vz = 0; // componentes de velocidad
        let lastTimestamp = null;

        // Ventana deslizante para promedio (últimos 5 s)
        const WINDOW_MS = 5000;
        const speedSamples = []; // { t, v }

        // Función para actualizar el texto en pantalla
        let currentAvgSpeed = 0; // velocidad global compartida

        function renderAvgSpeed() {
            if (speedSamples.length === 0) {
                avgSpeedEl.textContent = "0.0";
                currentAvgSpeed = 0;
                return;
            }

            let sum = 0;
            for (const s of speedSamples) sum += s.v;
            const avg = sum / speedSamples.length;

            currentAvgSpeed = avg; // <-- guardamos la velocidad global

            avgSpeedEl.textContent = avg.toFixed(2);
        }

        function startAcceleration() {
            if (!Protobject?.Acceleration) {
                console.warn(
                    "Acceleration component no disponible en Protobject.",
                );
                return;
            }

            // Pedimos datos cada ~200 ms
            Protobject.Acceleration.start(200);

            Protobject.Acceleration.onData((data) => {
                const now = Date.now();

                if (lastTimestamp == null) {
                    lastTimestamp = now;
                    return;
                }

                const dt = (now - lastTimestamp) / 1000; // segundos
                lastTimestamp = now;

                // Aceleración en cada eje (en m/s^2 normalmente)
                const ax = data.x;
                const ay = data.y;
                const az = data.z;

                // Integración sencilla: v(t) = v(t-1) + a * dt
                vx += ax * dt;
                vy += ay * dt;
                vz += az * dt;

                // Módulo de la velocidad (m/s)
                const speed = Math.sqrt(vx * vx + vy * vy + vz * vz);

                // Guardar muestra en la ventana deslizante
                speedSamples.push({ t: now, v: speed });

                // Eliminar muestras más antiguas que WINDOW_MS
                const cutoff = now - WINDOW_MS;
                while (speedSamples.length && speedSamples[0].t < cutoff) {
                    speedSamples.shift();
                }

                // Actualizar texto en pantalla
                renderAvgSpeed();
            });
        }
    </script>
</body>

</html>